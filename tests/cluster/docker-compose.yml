# Docker Compose for Redis Cluster testing
# This creates a minimal 3-master + 3-replica Redis Cluster for integration tests
#
# Usage:
#   docker compose -f tests/cluster/docker-compose.yml --profile test up --build --abort-on-container-exit
#
# Tests run inside Docker on the same network as Redis nodes, avoiding NAT issues.

x-redis-node: &redis-node
  image: redis:7.4
  command: >
    redis-server
    --port 6379
    --cluster-enabled yes
    --cluster-config-file nodes.conf
    --cluster-node-timeout 5000
    --appendonly yes
  healthcheck:
    test: ["CMD", "redis-cli", "ping"]
    interval: 1s
    timeout: 3s
    retries: 30
  networks:
    - redis-cluster

services:
  redis-node-1:
    <<: *redis-node

  redis-node-2:
    <<: *redis-node

  redis-node-3:
    <<: *redis-node

  redis-node-4:
    <<: *redis-node

  redis-node-5:
    <<: *redis-node

  redis-node-6:
    <<: *redis-node

  # Cluster initializer - creates the cluster from the nodes
  cluster-init:
    image: redis:7.4
    depends_on:
      redis-node-1:
        condition: service_healthy
      redis-node-2:
        condition: service_healthy
      redis-node-3:
        condition: service_healthy
      redis-node-4:
        condition: service_healthy
      redis-node-5:
        condition: service_healthy
      redis-node-6:
        condition: service_healthy
    networks:
      - redis-cluster
    command: >-
      bash -c "echo 'Creating Redis Cluster...' &&
      redis-cli --cluster create redis-node-1:6379 redis-node-2:6379 redis-node-3:6379 redis-node-4:6379 redis-node-5:6379 redis-node-6:6379 --cluster-replicas 1 --cluster-yes &&
      echo 'Redis Cluster created successfully!'"

  # Test runner for running tests inside Docker (needed for macOS/Windows)
  test-runner:
    build:
      context: ../..
      dockerfile: tests/cluster/Dockerfile.test
    depends_on:
      - cluster-init
    networks:
      - redis-cluster
    environment:
      - CLUSTER_URL=redis+cluster://redis-node-1:6379
    volumes:
      - ../..:/app
    working_dir: /app
    profiles:
      - test

networks:
  redis-cluster:
    driver: bridge
